<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Truppers Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --primary: #00ffcc;
  --secondary: #7b2cff;
  --accent: #ff4d4d;
  --dark: #0a0a14;
  --darker: #050510;
  --light: #ffffff;
  --gray: #a0a0c0;
  --glass: rgba(20, 20, 40, 0.8);
  --glass-border: rgba(100, 255, 255, 0.2);
  --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  --neon-glow: 0 0 15px var(--primary);
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: 
    radial-gradient(circle at 20% 30%, rgba(123, 44, 255, 0.15) 0%, transparent 40%),
    radial-gradient(circle at 80% 70%, rgba(0, 255, 204, 0.1) 0%, transparent 40%),
    var(--darker);
  color: var(--light);
  min-height: 100vh;
  padding: 20px;
  font-size: 1rem;
  overflow-x: hidden;
}

/* Main container */
.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 20px;
  background: var(--glass);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  animation: fadeIn 0.5s ease;
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.header h1 {
  font-size: 2.2rem;
  font-weight: 800;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  letter-spacing: 0.5px;
}

.stats {
  display: flex;
  gap: 15px;
}

.stat-box {
  background: rgba(0, 0, 0, 0.3);
  padding: 15px 20px;
  border-radius: 15px;
  text-align: center;
  border: 1px solid var(--glass-border);
  min-width: 110px;
  animation: slideUp 0.5s ease;
}

.stat-box:nth-child(1) { animation-delay: 0.1s; }
.stat-box:nth-child(2) { animation-delay: 0.2s; }
.stat-box:nth-child(3) { animation-delay: 0.3s; }

.stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.85rem;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Controls */
.controls {
  display: flex;
  gap: 20px;
  margin-bottom: 25px;
  padding: 20px;
  background: var(--glass);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  animation: fadeIn 0.6s ease;
}

.search-container {
  flex: 1;
  position: relative;
  min-width: 300px;
}

.search-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--primary);
  font-size: 1.1rem;
}

.search-input {
  width: 100%;
  padding: 12px 15px 12px 45px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: white;
  font-size: 1rem;
  transition: var(--transition);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: var(--neon-glow);
}

.filter-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 10px 18px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: white;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.filter-btn:hover {
  background: rgba(0, 255, 204, 0.1);
  border-color: var(--primary);
}

.filter-btn.active {
  background: rgba(0, 255, 204, 0.2);
  border-color: var(--primary);
  color: var(--primary);
}

.btn-danger {
  background: rgba(255, 77, 77, 0.2);
  border: 1px solid rgba(255, 77, 77, 0.4);
  color: var(--accent);
}

.btn-danger:hover {
  background: rgba(255, 77, 77, 0.3);
  border-color: var(--accent);
  box-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
}

/* Table Container */
.table-container {
  background: var(--glass);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: 30px;
  animation: fadeIn 0.7s ease;
}

.table-header {
  padding: 20px;
  border-bottom: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.table-header h2 {
  font-size: 1.5rem;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.table-wrapper {
  overflow-x: auto;
  max-height: 70vh;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) var(--dark);
}

.table-wrapper::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.table-wrapper::-webkit-scrollbar-track {
  background: var(--dark);
}

.table-wrapper::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1200px;
}

thead {
  background: rgba(0, 0, 0, 0.4);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 18px 15px;
  text-align: left;
  font-weight: 600;
  color: var(--primary);
  border-bottom: 2px solid var(--glass-border);
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

/* Optimized column widths */
th:nth-child(1) { width: 100px; }  /* Photo */
th:nth-child(2) { width: 200px; min-width: 180px; }  /* Full Name */
th:nth-child(3) { width: 180px; }  /* Phone Number */
th:nth-child(4) { width: 160px; }  /* Verification Code */
th:nth-child(5) { width: 300px; min-width: 280px; }  /* Actions */

td {
  padding: 15px;
  border-bottom: 1px solid var(--glass-border);
  font-size: 0.95rem;
  vertical-align: middle;
  transition: var(--transition);
}

tr {
  transition: var(--transition);
  animation: fadeInRow 0.3s ease;
}

/* Normal row hover */
tr:hover {
  background: rgba(0, 255, 204, 0.05);
}

/* SIMPLIFIED: Flagged row styling - ONLY RED BACKGROUND */
tr.flagged {
  background: rgba(255, 77, 77, 0.15); /* Red tint only */
}

tr.flagged:hover {
  background: rgba(255, 77, 77, 0.25); /* Darker red on hover */
}

/* Member photo */
.member-photo-container {
  width: 70px;
  height: 70px;
  position: relative;
}

.member-photo {
  width: 100%;
  height: 100%;
  border-radius: 10px;
  object-fit: cover;
  border: 2px solid var(--glass-border);
  transition: var(--transition);
  background: rgba(0, 0, 0, 0.2);
}

.member-photo:hover {
  transform: scale(1.5);
  border-color: var(--primary);
  z-index: 10;
  position: absolute;
  top: 0;
  left: 0;
  box-shadow: var(--shadow);
}

/* Name cell */
.name-cell {
  font-weight: 600;
  color: var(--light);
}

/* Phone cell */
.phone-cell {
  color: var(--gray);
  font-family: monospace;
  font-size: 0.95rem;
}

/* Verification code */
.verification-code {
  font-family: 'Courier New', monospace;
  background: rgba(0, 0, 0, 0.3);
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: 600;
  letter-spacing: 1px;
  color: var(--primary);
  font-size: 0.95rem;
  display: inline-block;
  min-width: 120px;
  text-align: center;
}

/* Action buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: nowrap;
}

.btn {
  padding: 8px 15px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  min-width: 80px;
  justify-content: center;
}

.btn i {
  font-size: 0.9rem;
}

.btn-flag {
  background: rgba(255, 77, 77, 0.2);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.4);
}

.btn-flag:hover {
  background: rgba(255, 77, 77, 0.3);
  box-shadow: 0 0 8px rgba(255, 77, 77, 0.5);
}

.btn-view {
  background: rgba(0, 255, 204, 0.1);
  color: var(--primary);
  border: 1px solid rgba(0, 255, 204, 0.3);
}

.btn-view:hover {
  background: rgba(0, 255, 204, 0.2);
  box-shadow: 0 0 8px rgba(0, 255, 204, 0.5);
}

.btn-unflag {
  background: rgba(123, 44, 255, 0.2);
  color: var(--secondary);
  border: 1px solid rgba(123, 44, 255, 0.4);
}

.btn-unflag:hover {
  background: rgba(123, 44, 255, 0.3);
  box-shadow: 0 0 8px rgba(123, 44, 255, 0.5);
}

.btn-delete {
  background: rgba(255, 77, 77, 0.1);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.3);
}

.btn-delete:hover {
  background: rgba(255, 77, 77, 0.2);
  box-shadow: 0 0 8px rgba(255, 77, 77, 0.3);
}

/* Status badge (SIMPLIFIED - only in modal) */
.status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-flagged {
  background: rgba(255, 77, 77, 0.2);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.4);
}

.badge-active {
  background: rgba(0, 255, 204, 0.1);
  color: var(--primary);
  border: 1px solid rgba(0, 255, 204, 0.3);
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(5, 5, 16, 0.95);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  padding: 20px;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--glass);
  border-radius: 20px;
  padding: 30px;
  max-width: 800px;
  width: 100%;
  border: 1px solid var(--glass-border);
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
  transform: translateY(30px);
  transition: transform 0.4s;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-overlay.active .modal {
  transform: translateY(0);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--glass-border);
}

.modal-header h2 {
  font-size: 1.8rem;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  background: none;
  border: none;
  color: var(--gray);
  font-size: 1.8rem;
  cursor: pointer;
  transition: var(--transition);
  padding: 5px;
  line-height: 1;
}

.modal-close:hover {
  color: var(--primary);
  transform: rotate(90deg);
}

.modal-content {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 25px;
}

.modal-photo {
  width: 100%;
  height: 250px;
  border-radius: 15px;
  border: 2px solid var(--glass-border);
  object-fit: cover;
  background: rgba(0, 0, 0, 0.2);
}

.modal-details {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.detail-row {
  display: flex;
  margin-bottom: 12px;
  align-items: flex-start;
}

.detail-label {
  min-width: 140px;
  font-weight: 600;
  color: var(--primary);
  font-size: 1rem;
}

.detail-value {
  flex: 1;
  font-size: 1rem;
  word-break: break-word;
  color: var(--light);
}

/* Confirmation Modal */
.confirmation-modal .modal {
  max-width: 500px;
}

.confirmation-actions {
  display: flex;
  gap: 15px;
  margin-top: 25px;
}

.confirm-btn {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.confirm-yes {
  background: rgba(255, 77, 77, 0.2);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.4);
}

.confirm-yes:hover {
  background: rgba(255, 77, 77, 0.3);
}

.confirm-no {
  background: rgba(0, 255, 204, 0.1);
  color: var(--primary);
  border: 1px solid rgba(0, 255, 204, 0.3);
}

.confirm-no:hover {
  background: rgba(0, 255, 204, 0.2);
}

/* Footer */
.footer {
  text-align: center;
  padding: 20px;
  color: var(--gray);
  font-size: 0.85rem;
  border-top: 1px solid var(--glass-border);
  margin-top: 30px;
  opacity: 0.8;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInRow {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--glass);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  padding: 15px 20px;
  color: white;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 9999;
  animation: slideIn 0.3s ease;
  box-shadow: var(--shadow);
  max-width: 400px;
}

/* Loader */
#globalLoader {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  color: var(--primary);
  z-index: 9999;
  background: rgba(0,0,0,0.7);
  padding: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Responsive */
@media (max-width: 1200px) {
  .container {
    padding: 15px;
  }
  
  .header {
    flex-direction: column;
    gap: 20px;
    text-align: center;
  }
  
  .stats {
    width: 100%;
    justify-content: center;
  }
  
  .controls {
    flex-direction: column;
  }
  
  .search-container {
    min-width: 100%;
  }
}

@media (max-width: 768px) {
  body {
    padding: 10px;
    font-size: 0.9rem;
  }
  
  .header h1 {
    font-size: 1.8rem;
  }
  
  .stat-box {
    min-width: 90px;
    padding: 12px 15px;
  }
  
  .stat-value {
    font-size: 1.5rem;
  }
  
  th, td {
    padding: 12px 10px;
  }
  
  .member-photo-container {
    width: 60px;
    height: 60px;
  }
  
  .btn {
    padding: 6px 12px;
    font-size: 0.85rem;
    min-width: 70px;
  }
  
  .modal-content {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .modal-photo {
    height: 200px;
  }
}

@media (max-width: 480px) {
  .header h1 {
    font-size: 1.6rem;
  }
  
  .stats {
    flex-wrap: wrap;
  }
  
  .stat-box {
    flex: 1;
    min-width: calc(33.333% - 10px);
  }
  
  .filter-buttons {
    flex-direction: column;
  }
  
  .filter-btn {
    width: 100%;
    justify-content: center;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
}
</style>
</head>

<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1><i class="fas fa-shield-alt"></i> TRUPPERS ADMIN</h1>
    <div class="stats">
      <div class="stat-box">
        <div class="stat-value" id="totalMembers">0</div>
        <div class="stat-label">Total Members</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="flaggedMembers">0</div>
        <div class="stat-label">Flagged</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="verifiedMembers">0</div>
        <div class="stat-label">Verified</div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" class="search-input" id="searchInput" placeholder="Search members...">
    </div>
    <div class="filter-buttons">
      <button class="filter-btn active" id="filterAllBtn">
        <i class="fas fa-users"></i> All Members
      </button>
      <button class="filter-btn" id="filterFlaggedBtn">
        <i class="fas fa-flag"></i> Flagged Only
      </button>
      <button class="filter-btn" id="filterUnflaggedBtn">
        <i class="fas fa-check-circle"></i> Not Flagged
      </button>
      <button class="filter-btn btn-danger" id="clearAllBtn">
        <i class="fas fa-trash"></i> Clear All
      </button>
    </div>
  </div>

  <!-- Members Table -->
  <div class="table-container">
    <div class="table-header">
      <h2><i class="fas fa-table"></i> Member Registry</h2>
      <div style="color: var(--gray);">
        <i class="fas fa-sync-alt" id="refreshBtn" style="cursor: pointer; margin-right: 15px;"></i>
        <span id="tableCount">0 members</span>
      </div>
    </div>
    
    <div class="table-wrapper">
      <table id="membersTable">
        <thead>
          <tr>
            <th>Photo</th>
            <th>Full Name</th>
            <th>Phone Number</th>
            <th>Verification Code</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>¬© 2023 Truppers Admin Panel | Secure Member Management System</p>
  </div>
</div>

<!-- Member Detail Modal -->
<div class="modal-overlay" id="memberModal">
  <div class="modal">
    <div class="modal-header">
      <h2><i class="fas fa-user-circle"></i> Member Details</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-content" id="modalContent">
      <!-- Content will be loaded here -->
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay confirmation-modal" id="confirmationModal">
  <div class="modal">
    <div class="modal-header">
      <h2><i class="fas fa-exclamation-triangle"></i> Confirmation Required</h2>
      <button class="modal-close" onclick="closeConfirmationModal()">&times;</button>
    </div>
    <div id="confirmationContent">
      <!-- Content will be loaded here -->
    </div>
  </div>
</div>

<script>
// ============================================
// SUPABASE CONFIGURATION
// ============================================
const SUPABASE_CONFIG = {
    URL: "https://ybnvozrsmtjkxoyoyihi.supabase.co",
    ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlibnZvenJzbXRqa3hveW95aWhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNTQ5ODAsImV4cCI6MjA4MzczMDk4MH0.ErY9Hhzua5lRUC-M_Zi5zm1XtIU0LzGA5Xa1Com8jC4"
};

let supabase = null;

// ============================================
// GLOBAL STATE
// ============================================
let members = [];
let currentFilter = 'all';
let pendingAction = null;
let pendingMemberId = null;

// ============================================
// SUPABASE INITIALIZATION - FIXED REDECLARATION
// ============================================
function initSupabase() {
    if (typeof supabaseClient !== 'undefined') {
        // Global variable already exists from somewhere else
        supabase = supabaseClient;
        console.log('Using existing supabaseClient');
    } else if (window.supabase && !supabase) {
        supabase = window.supabase.createClient(
            SUPABASE_CONFIG.URL,
            SUPABASE_CONFIG.ANON_KEY
        );
        console.log('Supabase initialized successfully');
    }
    return supabase;
}

// ============================================
// MAKE FUNCTIONS GLOBALLY ACCESSIBLE
// ============================================
window.loadMembers = loadMembers;
window.filterMembers = filterMembers;
window.showClearAllConfirmation = showClearAllConfirmation;
window.viewMember = viewMember;
window.closeModal = closeModal;
window.closeConfirmationModal = closeConfirmationModal;

// ============================================
// SUPABASE MEMBER FUNCTIONS
// ============================================
class SupabaseMembers {
    // Fetch all members from Supabase
    static async fetchAll() {
        try {
            const client = initSupabase();
            if (!client) {
                throw new Error('Supabase not initialized');
            }

            const { data, error } = await client
                .from('members')
                .select('*')
                .order('created_at', { ascending: false });

            if (error) {
                console.error('Supabase fetch error:', error);
                throw error;
            }

            return data || [];
        } catch (error) {
            console.error('Error fetching members:', error);
            throw error;
        }
    }

    // Add flag case to member in Supabase
    static async addFlagCase(memberId, flagCase) {
        try {
            const client = initSupabase();
            if (!client) {
                throw new Error('Supabase not initialized');
            }

            const { data, error } = await client
                .from('members')
                .update({
                    is_flagged: true,
                    flag_case: flagCase || "No reason provided",
                    flagged_at: new Date().toISOString(),
                    updated_at: new Date().toISOString()
                })
                .eq('id', memberId)
                .select()
                .single();

            if (error) {
                console.error('Supabase flag error:', error);
                throw error;
            }

            return data;
        } catch (error) {
            console.error('Error flagging member:', error);
            throw error;
        }
    }

    // Remove flag from member in Supabase
    static async removeFlag(memberId) {
        try {
            const client = initSupabase();
            if (!client) {
                throw new Error('Supabase not initialized');
            }

            const { data, error } = await client
                .from('members')
                .update({
                    is_flagged: false,
                    flag_case: null,
                    flagged_at: null,
                    updated_at: new Date().toISOString()
                })
                .eq('id', memberId)
                .select()
                .single();

            if (error) {
                console.error('Supabase unflag error:', error);
                throw error;
            }

            return data;
        } catch (error) {
            console.error('Error unflagging member:', error);
            throw error;
        }
    }

    // Delete member from Supabase
    static async delete(memberId) {
        try {
            const client = initSupabase();
            if (!client) {
                throw new Error('Supabase not initialized');
            }

            // First, delete the member's image from storage if exists
            const member = members.find(m => m.id === memberId);
            if (member && member.image_storage_path) {
                await client.storage
                    .from('member-images')
                    .remove([member.image_storage_path]);
            }

            // Then delete from database
            const { error } = await client
                .from('members')
                .delete()
                .eq('id', memberId);

            if (error) {
                console.error('Supabase delete error:', error);
                throw error;
            }

            return true;
        } catch (error) {
            console.error('Error deleting member:', error);
            throw error;
        }
    }

    // Clear all members from Supabase
    static async clearAll() {
        try {
            const client = initSupabase();
            if (!client) {
                throw new Error('Supabase not initialized');
            }

            // Get all members to delete their images
            const { data: allMembers } = await client
                .from('members')
                .select('image_storage_path');

            // Delete all images from storage
            const imagePaths = allMembers
                .map(m => m.image_storage_path)
                .filter(path => path);

            if (imagePaths.length > 0) {
                await client.storage
                    .from('member-images')
                    .remove(imagePaths);
            }

            // Delete all members
            const { error } = await client
                .from('members')
                .delete()
                .neq('id', '00000000-0000-0000-0000-000000000000');

            if (error) {
                console.error('Supabase clear all error:', error);
                throw error;
            }

            return true;
        } catch (error) {
            console.error('Error clearing all members:', error);
            throw error;
        }
    }
}

// ============================================
// DATA STORAGE
// ============================================
class DataStorage {
    static saveMembers() {
        try {
            localStorage.setItem('truppers_members', JSON.stringify(members));
        } catch (e) {
            console.warn('Failed to save to localStorage:', e);
        }
    }

    static loadMembers() {
        try {
            const saved = localStorage.getItem('truppers_members');
            if (saved) {
                const loadedMembers = JSON.parse(saved);
                return loadedMembers.map(member => ({
                    ...member,
                    flag_case: member.flag_case || "",
                    flagged_at: member.flagged_at || null
                }));
            }
        } catch (e) {
            console.warn('Failed to load from localStorage:', e);
        }
        return [];
    }

    static clearAll() {
        localStorage.removeItem('truppers_members');
    }
}

// ============================================
// CORE FUNCTIONS WITH SUPABASE SYNC
// ============================================
async function loadMembers() {
    try {
        Utils.showLoading(true);
        
        // Try to load from Supabase first
        try {
            const supabaseMembers = await SupabaseMembers.fetchAll();
            members = supabaseMembers;
            DataStorage.saveMembers();
            Utils.showNotification(`Loaded ${members.length} members from database`, 'success');
        } catch (supabaseError) {
            console.warn('Using local storage due to Supabase error:', supabaseError);
            members = DataStorage.loadMembers();
            Utils.showNotification(`Loaded ${members.length} members from local storage`, 'warning');
        }
        
        updateStats();
        renderTable(members);
        
    } catch (error) {
        console.error("Error loading members:", error);
        Utils.showNotification('Failed to load members', 'error');
        members = [];
        updateStats();
        renderTable(members);
    } finally {
        Utils.showLoading(false);
    }
}

function updateStats() {
    const total = members.length;
    const flagged = members.filter(m => m.is_flagged).length;
    const verified = members.filter(m => m.is_verified).length;
    
    document.getElementById('totalMembers').textContent = total;
    document.getElementById('flaggedMembers').textContent = flagged;
    document.getElementById('verifiedMembers').textContent = verified;
    document.getElementById('tableCount').textContent = `${total} members`;
}

function renderTable(memberList) {
    const tbody = document.getElementById('tableBody');
    
    // Clear existing rows
    while (tbody.firstChild) {
        tbody.removeChild(tbody.firstChild);
    }
    
    if (memberList.length === 0) {
        tbody.innerHTML = `
      <tr>
        <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
          <i class="fas fa-user-slash" style="font-size: 2.5rem; margin-bottom: 15px; display: block;"></i>
          No members found
        </td>
      </tr>
    `;
        return;
    }
    
    // Use DocumentFragment for faster DOM manipulation
    const fragment = document.createDocumentFragment();
    
    memberList.forEach((member, index) => {
        const tr = document.createElement('tr');
        // Use is_flagged from Supabase
        if (member.is_flagged) tr.classList.add('flagged');
        
        // Add animation delay for staggered appearance
        tr.style.animationDelay = `${index * 0.05}s`;
        
        tr.innerHTML = `
      <td>
        <div class="member-photo-container">
          <img src="${member.image_url || 'https://via.placeholder.com/70/0a0a14/00ffcc?text=No+Photo'}" 
               class="member-photo" 
               alt="${member.full_name}"
               loading="lazy"
               onerror="this.src='https://via.placeholder.com/70/0a0a14/00ffcc?text=Error'">
        </div>
      </td>
      <td>
        <div class="name-cell">${member.full_name || 'N/A'}</div>
      </td>
      <td>
        <div class="phone-cell">${member.phone_number || 'N/A'}</div>
      </td>
      <td>
        <span class="verification-code">${member.verification_code || 'N/A'}</span>
      </td>
      <td>
        <div class="action-buttons">
          <button class="btn btn-view" onclick="viewMember('${member.id}')" title="View Details">
            <i class="fas fa-eye"></i> View
          </button>
          ${member.is_flagged ? 
            `<button class="btn btn-unflag" onclick="showUnflagConfirmation('${member.id}')" title="Unflag Member">
              <i class="fas fa-undo"></i> Unflag
            </button>` : 
            `<button class="btn btn-flag" onclick="showFlagConfirmation('${member.id}')" title="Flag Member">
              <i class="fas fa-flag"></i> Flag
            </button>`
          }
          <button class="btn btn-delete" onclick="showDeleteConfirmation('${member.id}')" title="Delete Member">
            <i class="fas fa-trash"></i> Delete
          </button>
        </div>
      </td>
    `;
        
        fragment.appendChild(tr);
    });
    
    tbody.appendChild(fragment);
}

// ============================================
// UTILITY FUNCTIONS
// ============================================
class Utils {
    static showNotification(message, type = 'info') {
        // Remove existing notifications
        document.querySelectorAll('.notification').forEach(n => n.remove());
        
        const notification = document.createElement('div');
        notification.className = `notification notification-${type}`;
        notification.innerHTML = `
      <i class="fas ${this.getNotificationIcon(type)}"></i>
      <span>${message}</span>
    `;
        
        document.body.appendChild(notification);
        
        // Auto remove after 3 seconds
        setTimeout(() => {
            if (notification.parentNode) {
                notification.style.animation = 'slideIn 0.3s ease reverse';
                setTimeout(() => notification.remove(), 300);
            }
        }, 3000);
        
        return notification;
    }
    
    static getNotificationIcon(type) {
        const icons = {
            success: 'fa-check-circle',
            error: 'fa-exclamation-circle',
            warning: 'fa-exclamation-triangle',
            info: 'fa-info-circle'
        };
        return icons[type] || icons.info;
    }
    
    static showLoading(show) {
        if (show) {
            const loader = document.createElement('div');
            loader.id = 'globalLoader';
            loader.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
            document.body.appendChild(loader);
        } else {
            const loader = document.getElementById('globalLoader');
            if (loader) loader.remove();
        }
    }
}

// ============================================
// FILTER AND SEARCH FUNCTIONS
// ============================================
function filterMembers(filter) {
    currentFilter = filter;
    
    // Update active button
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    let filtered = [...members];
    
    if (filter === 'flagged') {
        filtered = members.filter(m => m.is_flagged);
    } else if (filter === 'unflagged') {
        filtered = members.filter(m => !m.is_flagged);
    }
    
    renderTable(filtered);
}

function searchMembers(query) {
    if (!query.trim()) {
        filterMembers(currentFilter);
        return;
    }
    
    const q = query.toLowerCase();
    const filtered = members.filter(m =>
        (m.full_name && m.full_name.toLowerCase().includes(q)) ||
        (m.phone_number && m.phone_number.toLowerCase().includes(q)) ||
        (m.verification_code && m.verification_code.toLowerCase().includes(q))
    );
    
    renderTable(filtered);
}

// ============================================
// MEMBER ACTION FUNCTIONS WITH SUPABASE SYNC
// ============================================
async function toggleFlag(memberId, flagStatus, flagCase = "") {
    try {
        Utils.showLoading(true);
        
        const memberIndex = members.findIndex(m => m.id === memberId);
        if (memberIndex === -1) {
            throw new Error('Member not found');
        }
        
        // Update in Supabase
        if (flagStatus) {
            await SupabaseMembers.addFlagCase(memberId, flagCase);
        } else {
            await SupabaseMembers.removeFlag(memberId);
        }
        
        // Update local state
        members[memberIndex].is_flagged = flagStatus;
        members[memberIndex].flag_case = flagStatus ? flagCase : "";
        members[memberIndex].flagged_at = flagStatus ? new Date().toISOString() : null;
        
        DataStorage.saveMembers();
        updateStats();
        
        // Re-render based on current filter
        let filtered = [...members];
        if (currentFilter === 'flagged') {
            filtered = members.filter(m => m.is_flagged);
        } else if (currentFilter === 'unflagged') {
            filtered = members.filter(m => !m.is_flagged);
        }
        
        renderTable(filtered);
        
        Utils.showNotification(
            `Member ${flagStatus ? 'flagged' : 'unflagged'} successfully`,
            'success'
        );
        
    } catch (error) {
        console.error("Error updating flag status:", error);
        Utils.showNotification('Failed to update member in database', 'error');
    } finally {
        Utils.showLoading(false);
        closeConfirmationModal();
    }
}

async function deleteMember(memberId) {
    try {
        Utils.showLoading(true);
        
        // Delete from Supabase
        await SupabaseMembers.delete(memberId);
        
        // Update local state
        members = members.filter(m => m.id !== memberId);
        DataStorage.saveMembers();
        updateStats();
        
        // Re-render based on current filter
        let filtered = [...members];
        if (currentFilter === 'flagged') {
            filtered = members.filter(m => m.is_flagged);
        } else if (currentFilter === 'unflagged') {
            filtered = members.filter(m => !m.is_flagged);
        }
        
        renderTable(filtered);
        Utils.showNotification('Member deleted successfully', 'success');
        
    } catch (error) {
        console.error("Error deleting member:", error);
        Utils.showNotification('Failed to delete member from database', 'error');
    } finally {
        Utils.showLoading(false);
        closeConfirmationModal();
    }
}

async function clearAllMembers() {
    try {
        Utils.showLoading(true);
        
        // Clear from Supabase
        await SupabaseMembers.clearAll();
        
        // Update local state
        members = [];
        DataStorage.clearAll();
        updateStats();
        renderTable(members);
        
        Utils.showNotification('All members cleared successfully', 'success');
        
    } catch (error) {
        console.error("Error clearing all members:", error);
        Utils.showNotification('Failed to clear members from database', 'error');
    } finally {
        Utils.showLoading(false);
        closeConfirmationModal();
    }
}

// ============================================
// MODAL FUNCTIONS
// ============================================
function showFlagConfirmation(memberId) {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    pendingAction = 'flag';
    pendingMemberId = memberId;
    
    document.getElementById('confirmationContent').innerHTML = `
    <p style="margin-bottom: 20px; line-height: 1.6;">
      Are you sure you want to flag <strong>${member.full_name}</strong>?<br>
      <small style="color: var(--gray);">Flagged members will have a red background in the table.</small>
    </p>
    
    <div style="margin-bottom: 20px;">
      <label for="flagReason" style="display: block; margin-bottom: 8px; color: var(--primary); font-weight: 600;">
        <i class="fas fa-file-alt"></i> Reason for Flagging:
      </label>
      <textarea 
        id="flagReason" 
        style="width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border); 
               border-radius: 8px; color: white; font-size: 1rem; min-height: 100px; resize: vertical;"
        placeholder="Enter reason for flagging this member (e.g., 'Suspicious activity', 'Verification needed', 'Payment issue')"
      ></textarea>
      <small style="color: var(--gray); display: block; margin-top: 5px;">
        This explanation will be stored with the member's record.
      </small>
    </div>
    
    <div class="confirmation-actions">
      <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
        <i class="fas fa-flag"></i> Yes, Flag Member
      </button>
      <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

function showUnflagConfirmation(memberId) {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    pendingAction = 'unflag';
    pendingMemberId = memberId;
    
    document.getElementById('confirmationContent').innerHTML = `
    <p style="margin-bottom: 20px; line-height: 1.6;">
      Are you sure you want to unflag <strong>${member.full_name}</strong>?<br>
      <small style="color: var(--gray);">This will remove the red background from the member's row.</small>
    </p>
    <div class="confirmation-actions">
      <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
        <i class="fas fa-undo"></i> Yes, Unflag Member
      </button>
      <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

function showDeleteConfirmation(memberId) {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    pendingAction = 'delete';
    pendingMemberId = memberId;
    
    document.getElementById('confirmationContent').innerHTML = `
    <p style="margin-bottom: 20px; line-height: 1.6; color: var(--accent);">
      <i class="fas fa-exclamation-circle"></i> WARNING: This action cannot be undone!
    </p>
    <p style="margin-bottom: 20px; line-height: 1.6;">
      Are you sure you want to permanently delete <strong>${member.full_name}</strong>?<br>
      <small style="color: var(--gray);">This will remove all member data including their photo.</small>
    </p>
    <div class="confirmation-actions">
      <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
        <i class="fas fa-trash"></i> Yes, Delete Permanently
      </button>
      <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

function showClearAllConfirmation() {
    if (members.length === 0) {
        Utils.showNotification('No members to clear', 'info');
        return;
    }
    
    pendingAction = 'clearAll';
    
    document.getElementById('confirmationContent').innerHTML = `
    <p style="margin-bottom: 20px; line-height: 1.6; color: var(--accent);">
      <i class="fas fa-exclamation-triangle"></i> DANGER: This action cannot be undone!
    </p>
    <p style="margin-bottom: 20px; line-height: 1.6;">
      Are you sure you want to delete ALL ${members.length} members?<br>
      <small style="color: var(--gray);">This will permanently delete all member records including flag cases and explanations.</small>
    </p>
    <div class="confirmation-actions">
      <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
        <i class="fas fa-trash"></i> Yes, Delete All
      </button>
      <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
        <i class="fas fa-times"></i> Cancel
      </button>
    </div>
  `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

async function executePendingAction() {
    try {
        const flagReason = pendingAction === 'flag' ? 
            document.getElementById('flagReason')?.value.trim() : "";
        
        switch(pendingAction) {
            case 'flag':
                await toggleFlag(pendingMemberId, true, flagReason);
                break;
            case 'unflag':
                await toggleFlag(pendingMemberId, false);
                break;
            case 'delete':
                await deleteMember(pendingMemberId);
                break;
            case 'clearAll':
                await clearAllMembers();
                break;
        }
    } catch (error) {
        console.error('Error executing action:', error);
        Utils.showNotification('Action failed', 'error');
    } finally {
        pendingAction = null;
        pendingMemberId = null;
    }
}

function closeConfirmationModal() {
    document.getElementById('confirmationModal').classList.remove('active');
    pendingAction = null;
    pendingMemberId = null;
}

function viewMember(memberId) {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    const modalContent = document.getElementById('modalContent');
    modalContent.innerHTML = `
    <div>
      <img src="${member.image_url || 'https://via.placeholder.com/400/0a0a14/00ffcc?text=No+Photo'}" 
           class="modal-photo" 
           alt="${member.full_name}"
           loading="lazy"
           onerror="this.src='https://via.placeholder.com/400/0a0a14/00ffcc?text=Error'">
    </div>
    <div class="modal-details">
      <div class="detail-row">
        <div class="detail-label">Full Name:</div>
        <div class="detail-value">${member.full_name || 'N/A'}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Phone Number:</div>
        <div class="detail-value" style="font-family: monospace;">${member.phone_number || 'N/A'}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Verification Code:</div>
        <div class="detail-value" style="font-family: monospace; color: var(--primary); font-weight: 600;">
          ${member.verification_code || 'N/A'}
        </div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Status:</div>
        <div class="detail-value">
          ${member.is_flagged ?
            '<span class="status-badge badge-flagged"><i class="fas fa-flag"></i> Flagged</span>' :
            '<span class="status-badge badge-active"><i class="fas fa-check-circle"></i> Active</span>'
          }
          ${member.is_verified ?
            '<span style="color: #25D366; margin-left: 15px;"><i class="fas fa-camera"></i> Verified</span>' :
            '<span style="color: var(--gray); margin-left: 15px;"><i class="fas fa-times-circle"></i> Not Verified</span>'
          }
        </div>
      </div>
${member.is_flagged && member.flag_case ?
  `<div class="detail-row">
    <div class="detail-label">Flag Reason:</div>
    <div class="detail-value" style="color: var(--accent); font-style: italic;">
      "${member.flag_case}"
    </div>
  </div>` :
  ''
}
${member.is_flagged && member.flagged_at ?
  `<div class="detail-row">
    <div class="detail-label">Flagged On:</div>
    <div class="detail-value">
      ${new Date(member.flagged_at).toLocaleDateString('en-US', {
        year: 'numeric',
        month: 'long',
        day: 'numeric',
        hour: '2-digit',
        minute: '2-digit'
      })}
    </div>
  </div>` :
  ''
}
      <div class="detail-row">
        <div class="detail-label">Member Since:</div>
        <div class="detail-value">${member.created_at ? new Date(member.created_at).toLocaleDateString('en-US', {
          year: 'numeric',
          month: 'long',
          day: 'numeric',
          hour: '2-digit',
          minute: '2-digit'
        }) : 'N/A'}</div>
      </div>
      <div class="detail-row">
        <div class="detail-label">Actions:</div>
        <div class="detail-value">
          <div class="action-buttons" style="margin-top: 10px;">
            ${member.is_flagged ? 
              `<button class="btn btn-unflag" onclick="showUnflagConfirmation('${member.id}'); closeModal();">
                <i class="fas fa-undo"></i> Unflag
              </button>` : 
              `<button class="btn btn-flag" onclick="showFlagConfirmation('${member.id}'); closeModal();">
                <i class="fas fa-flag"></i> Flag
              </button>`
            }
            <button class="btn btn-delete" onclick="showDeleteConfirmation('${member.id}'); closeModal();">
              <i class="fas fa-trash"></i> Delete
            </button>
          </div>
        </div>
      </div>
    </div>
  `;
    
    document.getElementById('memberModal').classList.add('active');
}

function closeModal() {
    document.getElementById('memberModal').classList.remove('active');
}

// ============================================
// INITIALIZATION
// ============================================
document.addEventListener('DOMContentLoaded', () => {
    // Initialize Supabase
    initSupabase();

    // Load members immediately
    loadMembers();

    // Set up search input listener with debounce
    const searchInput = document.getElementById('searchInput');
    let searchTimeout;

    searchInput.addEventListener('input', () => {
        clearTimeout(searchTimeout);
        searchTimeout = setTimeout(() => {
            searchMembers(searchInput.value);
        }, 200);
    });

    // ADD EVENT LISTENERS AFTER DOM CONTENT LOADED
    document.getElementById('filterAllBtn').addEventListener('click', function() {
        filterMembers('all');
    });
    document.getElementById('filterFlaggedBtn').addEventListener('click', function() {
        filterMembers('flagged');
    });
    document.getElementById('filterUnflaggedBtn').addEventListener('click', function() {
        filterMembers('unflagged');
    });
    document.getElementById('clearAllBtn').addEventListener('click', showClearAllConfirmation);
    document.getElementById('refreshBtn').addEventListener('click', loadMembers);

    // Close modals on escape key
    document.addEventListener('keydown', (e) => {
        if (e.key === 'Escape') {
            closeModal();
            closeConfirmationModal();
        }
    });

    // Close modals on overlay click
    document.getElementById('memberModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeModal();
        }
    });

    document.getElementById('confirmationModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeConfirmationModal();
        }
    });

    // Preload placeholder images
    const placeholder = new Image();
    placeholder.src = 'https://via.placeholder.com/70/0a0a14/00ffcc?text=No+Photo';

    console.log('‚úÖ Initialization complete');
});

// ============================================
// DEBUG HELPERS
// ============================================
window.debugAdmin = {
    getMembers: () => members,
    getSupabase: () => supabase,
    reload: () => loadMembers()
};

// Check if Supabase is Actually Connecting:
async function testSupabaseConnection() {
    try {
        const client = initSupabase();
        if (!client) {
            console.error('‚ùå Supabase client not initialized');
            return;
        }

        const { data, error } = await client.from('members').select('count');
        console.log('Supabase connection test:', data, error);

        if (error) {
            console.error('‚ùå Database error:', error);
        } else {
            console.log('‚úÖ Supabase connection successful');
        }
    } catch (e) {
        console.error('‚ùå Supabase connection failed:', e);
    }
}

// Temporary Workaround - Forced Refresh:
function forceLoadMembers() {
    console.log('üîÑ Forcing member load...');
    supabase = null; // Reset Supabase
    initSupabase();
    loadMembers();
}

// Add to debugAdmin
window.debugAdmin.testConnection = testSupabaseConnection;
window.debugAdmin.forceLoad = forceLoadMembers;

// Run connection test after init
setTimeout(() => {
    if (members.length === 0) {
        console.log('üîç Testing Supabase connection...');
        testSupabaseConnection();
    }
}, 2000);
</script>
</body>
</html>
