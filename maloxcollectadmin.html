<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Truppers Admin Dashboard</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<style>
:root {
  --primary: #00ffcc;
  --secondary: #7b2cff;
  --accent: #ff4d4d;
  --dark: #0a0a14;
  --darker: #050510;
  --light: #ffffff;
  --gray: #a0a0c0;
  --glass: rgba(20, 20, 40, 0.8);
  --glass-border: rgba(100, 255, 255, 0.2);
  --shadow: 0 10px 30px rgba(0, 0, 0, 0.5);
  --neon-glow: 0 0 15px var(--primary);
  --transition: all 0.3s ease;
}

* {
  margin: 0;
  padding: 0;
  box-sizing: border-box;
}

body {
  font-family: 'Segoe UI', system-ui, sans-serif;
  background: 
    radial-gradient(circle at 20% 30%, rgba(123, 44, 255, 0.15) 0%, transparent 40%),
    radial-gradient(circle at 80% 70%, rgba(0, 255, 204, 0.1) 0%, transparent 40%),
    var(--darker);
  color: var(--light);
  min-height: 100vh;
  padding: 20px;
  font-size: 1rem;
  overflow-x: hidden;
}

/* Main container */
.container {
  max-width: 1600px;
  margin: 0 auto;
  padding: 20px;
}

/* Header */
.header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 30px;
  padding: 20px;
  background: var(--glass);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  position: relative;
  overflow: hidden;
  animation: fadeIn 0.5s ease;
}

.header::before {
  content: '';
  position: absolute;
  top: 0;
  left: 0;
  width: 100%;
  height: 5px;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
}

.header h1 {
  font-size: 2.2rem;
  font-weight: 800;
  background: linear-gradient(90deg, var(--primary), var(--secondary));
  -webkit-background-clip: text;
  background-clip: text;
  color: transparent;
  letter-spacing: 0.5px;
}

.stats {
  display: flex;
  gap: 15px;
}

.stat-box {
  background: rgba(0, 0, 0, 0.3);
  padding: 15px 20px;
  border-radius: 15px;
  text-align: center;
  border: 1px solid var(--glass-border);
  min-width: 110px;
  animation: slideUp 0.5s ease;
}

.stat-box:nth-child(1) { animation-delay: 0.1s; }
.stat-box:nth-child(2) { animation-delay: 0.2s; }
.stat-box:nth-child(3) { animation-delay: 0.3s; }

.stat-value {
  font-size: 1.8rem;
  font-weight: 700;
  color: var(--primary);
  margin-bottom: 5px;
}

.stat-label {
  font-size: 0.85rem;
  color: var(--gray);
  text-transform: uppercase;
  letter-spacing: 1px;
}

/* Controls */
.controls {
  display: flex;
  gap: 20px;
  margin-bottom: 25px;
  padding: 20px;
  background: var(--glass);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  animation: fadeIn 0.6s ease;
}

.search-container {
  flex: 1;
  position: relative;
  min-width: 300px;
}

.search-icon {
  position: absolute;
  left: 15px;
  top: 50%;
  transform: translateY(-50%);
  color: var(--primary);
  font-size: 1.1rem;
}

.search-input {
  width: 100%;
  padding: 12px 15px 12px 45px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: white;
  font-size: 1rem;
  transition: var(--transition);
}

.search-input:focus {
  outline: none;
  border-color: var(--primary);
  box-shadow: var(--neon-glow);
}

.filter-buttons {
  display: flex;
  gap: 10px;
  flex-wrap: wrap;
}

.filter-btn {
  padding: 10px 18px;
  background: rgba(0, 0, 0, 0.3);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  color: white;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.95rem;
  display: flex;
  align-items: center;
  gap: 8px;
  white-space: nowrap;
}

.filter-btn:hover {
  background: rgba(0, 255, 204, 0.1);
  border-color: var(--primary);
}

.filter-btn.active {
  background: rgba(0, 255, 204, 0.2);
  border-color: var(--primary);
  color: var(--primary);
}

.btn-danger {
  background: rgba(255, 77, 77, 0.2);
  border: 1px solid rgba(255, 77, 77, 0.4);
  color: var(--accent);
}

.btn-danger:hover {
  background: rgba(255, 77, 77, 0.3);
  border-color: var(--accent);
  box-shadow: 0 0 10px rgba(255, 77, 77, 0.5);
}

/* Table Container */
.table-container {
  background: var(--glass);
  backdrop-filter: blur(10px);
  border-radius: 20px;
  border: 1px solid var(--glass-border);
  box-shadow: var(--shadow);
  overflow: hidden;
  margin-bottom: 30px;
  animation: fadeIn 0.7s ease;
}

.table-header {
  padding: 20px;
  border-bottom: 1px solid var(--glass-border);
  display: flex;
  justify-content: space-between;
  align-items: center;
}

.table-header h2 {
  font-size: 1.5rem;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.table-wrapper {
  overflow-x: auto;
  max-height: 70vh;
  scrollbar-width: thin;
  scrollbar-color: var(--primary) var(--dark);
}

.table-wrapper::-webkit-scrollbar {
  width: 8px;
  height: 8px;
}

.table-wrapper::-webkit-scrollbar-track {
  background: var(--dark);
}

.table-wrapper::-webkit-scrollbar-thumb {
  background: var(--primary);
  border-radius: 4px;
}

table {
  width: 100%;
  border-collapse: collapse;
  min-width: 1200px;
}

thead {
  background: rgba(0, 0, 0, 0.4);
  position: sticky;
  top: 0;
  z-index: 10;
}

th {
  padding: 18px 15px;
  text-align: left;
  font-weight: 600;
  color: var(--primary);
  border-bottom: 2px solid var(--glass-border);
  font-size: 1rem;
  text-transform: uppercase;
  letter-spacing: 0.5px;
  white-space: nowrap;
}

/* Optimized column widths */
th:nth-child(1) { width: 100px; }  /* Photo */
th:nth-child(2) { width: 200px; min-width: 180px; }  /* Full Name */
th:nth-child(3) { width: 180px; }  /* Phone Number */
th:nth-child(4) { width: 160px; }  /* Verification Code */
th:nth-child(5) { width: 300px; min-width: 280px; }  /* Actions */

td {
  padding: 15px;
  border-bottom: 1px solid var(--glass-border);
  font-size: 0.95rem;
  vertical-align: middle;
  transition: var(--transition);
}

tr {
  transition: var(--transition);
  animation: fadeInRow 0.3s ease;
}

/* Normal row hover */
tr:hover {
  background: rgba(0, 255, 204, 0.05);
}

/* SIMPLIFIED: Flagged row styling - ONLY RED BACKGROUND */
tr.flagged {
  background: rgba(255, 77, 77, 0.15); /* Red tint only */
}

tr.flagged:hover {
  background: rgba(255, 77, 77, 0.25); /* Darker red on hover */
}

/* Member photo */
.member-photo-container {
  width: 70px;
  height: 70px;
  position: relative;
}

.member-photo {
  width: 100%;
  height: 100%;
  border-radius: 10px;
  object-fit: cover;
  border: 2px solid var(--glass-border);
  transition: var(--transition);
  background: rgba(0, 0, 0, 0.2);
}

.member-photo:hover {
  transform: scale(1.5);
  border-color: var(--primary);
  z-index: 10;
  position: absolute;
  top: 0;
  left: 0;
  box-shadow: var(--shadow);
}

/* Name cell */
.name-cell {
  font-weight: 600;
  color: var(--light);
}

/* Phone cell */
.phone-cell {
  color: var(--gray);
  font-family: monospace;
  font-size: 0.95rem;
}

/* Verification code */
.verification-code {
  font-family: 'Courier New', monospace;
  background: rgba(0, 0, 0, 0.3);
  padding: 8px 12px;
  border-radius: 8px;
  font-weight: 600;
  letter-spacing: 1px;
  color: var(--primary);
  font-size: 0.95rem;
  display: inline-block;
  min-width: 120px;
  text-align: center;
}

/* Action buttons */
.action-buttons {
  display: flex;
  gap: 8px;
  flex-wrap: nowrap;
}

.btn {
  padding: 8px 15px;
  border-radius: 8px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-size: 0.9rem;
  display: flex;
  align-items: center;
  gap: 6px;
  white-space: nowrap;
  min-width: 80px;
  justify-content: center;
}

.btn i {
  font-size: 0.9rem;
}

.btn-flag {
  background: rgba(255, 77, 77, 0.2);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.4);
}

.btn-flag:hover {
  background: rgba(255, 77, 77, 0.3);
  box-shadow: 0 0 8px rgba(255, 77, 77, 0.5);
}

.btn-view {
  background: rgba(0, 255, 204, 0.1);
  color: var(--primary);
  border: 1px solid rgba(0, 255, 204, 0.3);
}

.btn-view:hover {
  background: rgba(0, 255, 204, 0.2);
  box-shadow: 0 0 8px rgba(0, 255, 204, 0.5);
}

.btn-unflag {
  background: rgba(123, 44, 255, 0.2);
  color: var(--secondary);
  border: 1px solid rgba(123, 44, 255, 0.4);
}

.btn-unflag:hover {
  background: rgba(123, 44, 255, 0.3);
  box-shadow: 0 0 8px rgba(123, 44, 255, 0.5);
}

.btn-delete {
  background: rgba(255, 77, 77, 0.1);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.3);
}

.btn-delete:hover {
  background: rgba(255, 77, 77, 0.2);
  box-shadow: 0 0 8px rgba(255, 77, 77, 0.3);
}

/* Status badge (SIMPLIFIED - only in modal) */
.status-badge {
  display: inline-block;
  padding: 4px 10px;
  border-radius: 20px;
  font-size: 0.8rem;
  font-weight: 600;
  text-transform: uppercase;
  letter-spacing: 0.5px;
}

.badge-flagged {
  background: rgba(255, 77, 77, 0.2);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.4);
}

.badge-active {
  background: rgba(0, 255, 204, 0.1);
  color: var(--primary);
  border: 1px solid rgba(0, 255, 204, 0.3);
}

/* Modal */
.modal-overlay {
  position: fixed;
  top: 0;
  left: 0;
  width: 100%;
  height: 100%;
  background: rgba(5, 5, 16, 0.95);
  backdrop-filter: blur(10px);
  display: flex;
  align-items: center;
  justify-content: center;
  z-index: 1000;
  opacity: 0;
  visibility: hidden;
  transition: opacity 0.3s, visibility 0.3s;
  padding: 20px;
}

.modal-overlay.active {
  opacity: 1;
  visibility: visible;
}

.modal {
  background: var(--glass);
  border-radius: 20px;
  padding: 30px;
  max-width: 800px;
  width: 100%;
  border: 1px solid var(--glass-border);
  box-shadow: 0 20px 50px rgba(0, 0, 0, 0.7);
  transform: translateY(30px);
  transition: transform 0.4s;
  max-height: 90vh;
  overflow-y: auto;
}

.modal-overlay.active .modal {
  transform: translateY(0);
}

.modal-header {
  display: flex;
  justify-content: space-between;
  align-items: center;
  margin-bottom: 25px;
  padding-bottom: 20px;
  border-bottom: 1px solid var(--glass-border);
}

.modal-header h2 {
  font-size: 1.8rem;
  color: var(--primary);
  display: flex;
  align-items: center;
  gap: 10px;
}

.modal-close {
  background: none;
  border: none;
  color: var(--gray);
  font-size: 1.8rem;
  cursor: pointer;
  transition: var(--transition);
  padding: 5px;
  line-height: 1;
}

.modal-close:hover {
  color: var(--primary);
  transform: rotate(90deg);
}

.modal-content {
  display: grid;
  grid-template-columns: 1fr 2fr;
  gap: 25px;
}

.modal-photo {
  width: 100%;
  height: 250px;
  border-radius: 15px;
  border: 2px solid var(--glass-border);
  object-fit: cover;
  background: rgba(0, 0, 0, 0.2);
}

.modal-details {
  display: flex;
  flex-direction: column;
  gap: 15px;
}

.detail-row {
  display: flex;
  margin-bottom: 12px;
  align-items: flex-start;
}

.detail-label {
  min-width: 140px;
  font-weight: 600;
  color: var(--primary);
  font-size: 1rem;
}

.detail-value {
  flex: 1;
  font-size: 1rem;
  word-break: break-word;
  color: var(--light);
}

/* Confirmation Modal */
.confirmation-modal .modal {
  max-width: 500px;
}

.confirmation-actions {
  display: flex;
  gap: 15px;
  margin-top: 25px;
}

.confirm-btn {
  flex: 1;
  padding: 12px;
  border-radius: 10px;
  border: none;
  font-weight: 600;
  cursor: pointer;
  transition: var(--transition);
  font-size: 1rem;
  display: flex;
  align-items: center;
  justify-content: center;
  gap: 8px;
}

.confirm-yes {
  background: rgba(255, 77, 77, 0.2);
  color: var(--accent);
  border: 1px solid rgba(255, 77, 77, 0.4);
}

.confirm-yes:hover {
  background: rgba(255, 77, 77, 0.3);
}

.confirm-no {
  background: rgba(0, 255, 204, 0.1);
  color: var(--primary);
  border: 1px solid rgba(0, 255, 204, 0.3);
}

.confirm-no:hover {
  background: rgba(0, 255, 204, 0.2);
}

/* Footer */
.footer {
  text-align: center;
  padding: 20px;
  color: var(--gray);
  font-size: 0.85rem;
  border-top: 1px solid var(--glass-border);
  margin-top: 30px;
  opacity: 0.8;
}

/* Animations */
@keyframes fadeIn {
  from { opacity: 0; transform: translateY(10px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes slideUp {
  from { opacity: 0; transform: translateY(20px); }
  to { opacity: 1; transform: translateY(0); }
}

@keyframes fadeInRow {
  from { opacity: 0; }
  to { opacity: 1; }
}

@keyframes slideIn {
  from {
    transform: translateX(100%);
    opacity: 0;
  }
  to {
    transform: translateX(0);
    opacity: 1;
  }
}

/* Notification */
.notification {
  position: fixed;
  top: 20px;
  right: 20px;
  background: var(--glass);
  backdrop-filter: blur(10px);
  border: 1px solid var(--glass-border);
  border-radius: 10px;
  padding: 15px 20px;
  color: white;
  display: flex;
  align-items: center;
  gap: 10px;
  z-index: 9999;
  animation: slideIn 0.3s ease;
  box-shadow: var(--shadow);
  max-width: 400px;
}

/* Loader */
#globalLoader {
  position: fixed;
  top: 50%;
  left: 50%;
  transform: translate(-50%, -50%);
  font-size: 2.5rem;
  color: var(--primary);
  z-index: 9999;
  background: rgba(0,0,0,0.7);
  padding: 20px;
  border-radius: 10px;
  display: flex;
  align-items: center;
  justify-content: center;
}

/* Responsive */
@media (max-width: 1200px) {
  .container {
    padding: 15px;
  }
  
  .header {
    flex-direction: column;
    gap: 20px;
    text-align: center;
  }
  
  .stats {
    width: 100%;
    justify-content: center;
  }
  
  .controls {
    flex-direction: column;
  }
  
  .search-container {
    min-width: 100%;
  }
}

@media (max-width: 768px) {
  body {
    padding: 10px;
    font-size: 0.9rem;
  }
  
  .header h1 {
    font-size: 1.8rem;
  }
  
  .stat-box {
    min-width: 90px;
    padding: 12px 15px;
  }
  
  .stat-value {
    font-size: 1.5rem;
  }
  
  th, td {
    padding: 12px 10px;
  }
  
  .member-photo-container {
    width: 60px;
    height: 60px;
  }
  
  .btn {
    padding: 6px 12px;
    font-size: 0.85rem;
    min-width: 70px;
  }
  
  .modal-content {
    grid-template-columns: 1fr;
    gap: 20px;
  }
  
  .modal-photo {
    height: 200px;
  }
}

@media (max-width: 480px) {
  .header h1 {
    font-size: 1.6rem;
  }
  
  .stats {
    flex-wrap: wrap;
  }
  
  .stat-box {
    flex: 1;
    min-width: calc(33.333% - 10px);
  }
  
  .filter-buttons {
    flex-direction: column;
  }
  
  .filter-btn {
    width: 100%;
    justify-content: center;
  }
  
  .action-buttons {
    flex-direction: column;
  }
  
  .btn {
    width: 100%;
  }
}
</style>
</head>

<body>
<div class="container">
  <!-- Header -->
  <div class="header">
    <h1><i class="fas fa-shield-alt"></i> TRUPPERS ADMIN</h1>
    <div class="stats">
      <div class="stat-box">
        <div class="stat-value" id="totalMembers">0</div>
        <div class="stat-label">Total Members</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="flaggedMembers">0</div>
        <div class="stat-label">Flagged</div>
      </div>
      <div class="stat-box">
        <div class="stat-value" id="verifiedMembers">0</div>
        <div class="stat-label">Verified</div>
      </div>
    </div>
  </div>

  <!-- Controls -->
  <div class="controls">
    <div class="search-container">
      <i class="fas fa-search search-icon"></i>
      <input type="text" class="search-input" id="searchInput" placeholder="Search members...">
    </div>
    <div class="filter-buttons">
      <button class="filter-btn active" id="filterAllBtn">
        <i class="fas fa-users"></i> All Members
      </button>
      <button class="filter-btn" id="filterFlaggedBtn">
        <i class="fas fa-flag"></i> Flagged Only
      </button>
      <button class="filter-btn" id="filterUnflaggedBtn">
        <i class="fas fa-check-circle"></i> Not Flagged
      </button>
      <button class="filter-btn btn-danger" id="clearAllBtn">
        <i class="fas fa-trash"></i> Clear All
      </button>
    </div>
  </div>

  <!-- Members Table -->
  <div class="table-container">
    <div class="table-header">
      <h2><i class="fas fa-table"></i> Member Registry</h2>
      <div style="color: var(--gray);">
        <i class="fas fa-sync-alt" id="refreshBtn" style="cursor: pointer; margin-right: 15px;"></i>
        <span id="tableCount">0 members</span>
      </div>
    </div>
    
    <div class="table-wrapper">
      <table id="membersTable">
        <thead>
          <tr>
            <th>Photo</th>
            <th>Full Name</th>
            <th>Phone Number</th>
            <th>Verification Code</th>
            <th>Actions</th>
          </tr>
        </thead>
        <tbody id="tableBody">
          <!-- Data will be loaded here -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- Footer -->
  <div class="footer">
    <p>¬© 2023 Truppers Admin Panel | Secure Member Management System</p>
  </div>
</div>

<!-- Member Detail Modal -->
<div class="modal-overlay" id="memberModal">
  <div class="modal">
    <div class="modal-header">
      <h2><i class="fas fa-user-circle"></i> Member Details</h2>
      <button class="modal-close" onclick="closeModal()">&times;</button>
    </div>
    <div class="modal-content" id="modalContent">
      <!-- Content will be loaded here -->
    </div>
  </div>
</div>

<!-- Confirmation Modal -->
<div class="modal-overlay confirmation-modal" id="confirmationModal">
  <div class="modal">
    <div class="modal-header">
      <h2><i class="fas fa-exclamation-triangle"></i> Confirmation Required</h2>
      <button class="modal-close" onclick="closeConfirmationModal()">&times;</button>
    </div>
    <div id="confirmationContent">
      <!-- Content will be loaded here -->
    </div>
  </div>
</div>

<script>
// ============================================
// SUPABASE CONFIGURATION - USE YOUR EXACT CREDENTIALS
// ============================================
const SUPABASE_CONFIG = {
    URL: "https://ybnvozrsmtjkxoyoyihi.supabase.co",
    ANON_KEY: "eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InlibnZvenJzbXRqa3hveW95aWhpIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgxNTQ5ODAsImV4cCI6MjA4MzczMDk4MH0.ErY9Hhzua5lRUC-M_Zi5zm1XtIU0LzGA5Xa1Com8jC4"
};

// ============================================
// GLOBAL VARIABLES
// ============================================
let supabaseClient = null;
let members = [];
let currentFilter = 'all';
let pendingMemberId = null;
let pendingAction = null;

// ============================================
// 1. SUPABASE INITIALIZATION
// ============================================
function initializeSupabase() {
    console.log("Initializing Supabase...");
    
    if (window.supabase) {
        try {
            supabaseClient = window.supabase.createClient(
                SUPABASE_CONFIG.URL,
                SUPABASE_CONFIG.ANON_KEY
            );
            console.log("Supabase initialized successfully");
            return supabaseClient;
        } catch (error) {
            console.error("Failed to create Supabase client:", error);
            return null;
        }
    } else {
        console.error("Supabase JS library not loaded!");
        return null;
    }
}

// ============================================
// 2. MEMBER VIEW MODULE (COMPLETE)
// ============================================
function viewMember(memberId) {
    console.log(`Viewing member: ${memberId}`);
    
    const member = members.find(m => m.id === memberId);
    if (!member) {
        showAlert("Member not found", 'error');
        return;
    }
    
    // Build modal content
    const modalContent = document.getElementById('modalContent');
    if (!modalContent) {
        console.error("Modal content element not found!");
        return;
    }
    
    const htmlContent = `
        <div>
            <img src="${member.image_url || 'https://via.placeholder.com/400/0a0a14/00ffcc?text=No+Photo'}" 
                 class="modal-photo" 
                 alt="${member.full_name}"
                 onerror="this.src='https://via.placeholder.com/400/0a0a14/00ffcc?text=Error'">
        </div>
        <div class="modal-details">
            <div class="detail-row">
                <div class="detail-label">Full Name:</div>
                <div class="detail-value">${escapeHtml(member.full_name) || 'N/A'}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Phone Number:</div>
                <div class="detail-value" style="font-family: monospace;">${escapeHtml(member.phone_number) || 'N/A'}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Verification Code:</div>
                <div class="detail-value" style="font-family: monospace; color: var(--primary); font-weight: 600;">
                    ${escapeHtml(member.verification_code) || 'N/A'}
                </div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Status:</div>
                <div class="detail-value">
                    ${member.is_flagged ?
                        '<span class="status-badge badge-flagged"><i class="fas fa-flag"></i> Flagged</span>' :
                        '<span class="status-badge badge-active"><i class="fas fa-check-circle"></i> Active</span>'
                    }
                    ${member.is_verified ?
                        '<span style="color: #25D366; margin-left: 15px;"><i class="fas fa-camera"></i> Verified</span>' :
                        '<span style="color: var(--gray); margin-left: 15px;"><i class="fas fa-times-circle"></i> Not Verified</span>'
                    }
                </div>
            </div>
            ${member.flag_case ?
                `<div class="detail-row">
                    <div class="detail-label">Flag Reason:</div>
                    <div class="detail-value" style="color: var(--accent); font-style: italic;">
                        "${escapeHtml(member.flag_case)}"
                    </div>
                </div>` : ''
            }
            ${member.flagged_at ?
                `<div class="detail-row">
                    <div class="detail-label">Flagged On:</div>
                    <div class="detail-value">
                        ${new Date(member.flagged_at).toLocaleDateString('en-US', {
                            year: 'numeric',
                            month: 'long',
                            day: 'numeric',
                            hour: '2-digit',
                            minute: '2-digit'
                        })}
                    </div>
                </div>` : ''
            }
            <div class="detail-row">
                <div class="detail-label">Member Since:</div>
                <div class="detail-value">${member.created_at ? new Date(member.created_at).toLocaleDateString('en-US', {
                    year: 'numeric',
                    month: 'long',
                    day: 'numeric',
                    hour: '2-digit',
                    minute: '2-digit'
                }) : 'N/A'}</div>
            </div>
            <div class="detail-row">
                <div class="detail-label">Actions:</div>
                <div class="detail-value">
                    <div class="action-buttons" style="margin-top: 10px;">
                        ${member.is_flagged ? 
                            `<button class="btn btn-unflag" onclick="showUnflagConfirmation('${member.id}'); closeModal();">
                                <i class="fas fa-undo"></i> Unflag
                            </button>` : 
                            `<button class="btn btn-flag" onclick="showFlagConfirmation('${member.id}'); closeModal();">
                                <i class="fas fa-flag"></i> Flag
                            </button>`
                        }
                        <button class="btn btn-delete" onclick="showDeleteConfirmation('${member.id}'); closeModal();">
                            <i class="fas fa-trash"></i> Delete
                        </button>
                    </div>
                </div>
            </div>
        </div>
    `;
    
    modalContent.innerHTML = htmlContent;
    document.getElementById('memberModal').classList.add('active');
}

function closeModal() {
    document.getElementById('memberModal').classList.remove('active');
}

// ============================================
// 3. FLAG MEMBER MODULE (COMPLETE)
// ============================================
function showFlagConfirmation(memberId) {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    pendingAction = 'flag';
    pendingMemberId = memberId;
    
    document.getElementById('confirmationContent').innerHTML = `
        <p style="margin-bottom: 20px; line-height: 1.6;">
            Are you sure you want to flag <strong>${escapeHtml(member.full_name)}</strong>?<br>
            <small style="color: var(--gray);">Flagged members will have a red background in the table.</small>
        </p>
        
        <div style="margin-bottom: 20px;">
            <label for="flagReason" style="display: block; margin-bottom: 8px; color: var(--primary); font-weight: 600;">
                <i class="fas fa-file-alt"></i> Reason for Flagging:
            </label>
            <textarea 
                id="flagReason" 
                style="width: 100%; padding: 12px; background: rgba(0, 0, 0, 0.3); border: 1px solid var(--glass-border); 
                       border-radius: 8px; color: white; font-size: 1rem; min-height: 100px; resize: vertical;"
                placeholder="Enter reason for flagging this member (e.g., 'Suspicious activity', 'Verification needed', 'Payment issue')"
            ></textarea>
            <small style="color: var(--gray); display: block; margin-top: 5px;">
                This explanation will be stored with the member's record.
            </small>
        </div>
        
        <div class="confirmation-actions">
            <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
                <i class="fas fa-flag"></i> Yes, Flag Member
            </button>
            <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

// ============================================
// UPDATED FLAG MEMBER FUNCTION (FIXED)
// ============================================
async function flagMember(memberId, flagCase) {
    console.log(`üö® FLAG MEMBER CALLED: ${memberId}`);
    console.log(`   Reason: ${flagCase || 'No reason provided'}`);
    
    // Validation
    if (!memberId) {
        showAlert("Invalid member ID", 'error');
        return false;
    }
    
    if (!supabaseClient) {
        showAlert("Database connection failed. Please refresh the page.", 'error');
        return false;
    }
    
    try {
        // First, let's check what columns exist
        console.log("1. Checking database schema...");
        const { data: schemaCheck, error: schemaError } = await supabaseClient
            .from('members')
            .select('id')
            .eq('id', memberId)
            .limit(1);
        
        if (schemaError) {
            console.error("Schema check error:", schemaError);
            throw new Error(`Database error: ${schemaError.message}`);
        }
        
        if (!schemaCheck || schemaCheck.length === 0) {
            throw new Error("Member not found in database");
        }
        
        // Prepare update data - SAFE VERSION
        const updateData = {
            is_flagged: true,
            updated_at: new Date().toISOString()
        };
        
        // Add flag_case only if column exists (we'll check first)
        console.log("2. Attempting to update with flag_case...");
        
        // Try with flag_case first
        const updateWithCase = {
            ...updateData,
            flag_case: flagCase || "No reason provided",
            flagged_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('members')
            .update(updateWithCase)
            .eq('id', memberId)
            .select()
            .single();
        
        if (error) {
            console.log("3. First update failed, trying without flag_case...");
            console.log("   Error:", error.message);
            
            // If error is about column, try without flag_case
            if (error.message.includes('column') && error.message.includes('flag_case')) {
                // Column doesn't exist, try without it
                const updateWithoutCase = {
                    ...updateData,
                    flagged_at: new Date().toISOString()
                };
                
                const { data: data2, error: error2 } = await supabaseClient
                    .from('members')
                    .update(updateWithoutCase)
                    .eq('id', memberId)
                    .select()
                    .single();
                
                if (error2) {
                    console.error("Second update also failed:", error2);
                    throw error2;
                }
                
                console.log("4. Updated successfully (without flag_case column)");
                showAlert(`Member flagged (no reason saved - column missing)`, 'warning');
                
                // Update local state
                updateLocalMember(memberId, {
                    is_flagged: true,
                    flag_case: flagCase || "No reason provided",
                    flagged_at: new Date().toISOString()
                });
                
            } else {
                // Some other error
                throw error;
            }
        } else {
            console.log("3. Updated successfully with flag_case!");
            showAlert(`Member "${data.full_name}" has been flagged`, 'success');
            
            // Update local state
            updateLocalMember(memberId, {
                is_flagged: true,
                flag_case: flagCase || "No reason provided",
                flagged_at: new Date().toISOString()
            });
        }
        
        // Refresh the UI
        refreshUIAfterFlag();
        return true;
        
    } catch (error) {
        console.error("‚ùå CRITICAL FLAG ERROR:", error);
        
        // More detailed error messages
        let errorMessage = `Failed to flag member: ${error.message}`;
        
        if (error.message.includes('permission')) {
            errorMessage = "Database permission denied. Check Supabase RLS policies.";
        } else if (error.message.includes('network')) {
            errorMessage = "Network error. Check your internet connection.";
        } else if (error.message.includes('JWT')) {
            errorMessage = "Authentication failed. The API key may be invalid.";
        }
        
        showAlert(errorMessage, 'error');
        return false;
    }
}

// ============================================
// UPDATED UNFLAG MEMBER FUNCTION (FIXED)
// ============================================
async function unflagMember(memberId) {
    console.log(`üö® UNFLAG MEMBER CALLED: ${memberId}`);
    
    if (!memberId || !supabaseClient) {
        showAlert("Invalid request", 'error');
        return false;
    }
    
    try {
        // Try with flag_case first
        const updateData = {
            is_flagged: false,
            flag_case: null,
            flagged_at: null,
            updated_at: new Date().toISOString()
        };
        
        const { data, error } = await supabaseClient
            .from('members')
            .update(updateData)
            .eq('id', memberId)
            .select()
            .single();
        
        if (error) {
            // If flag_case column doesn't exist, try without it
            if (error.message.includes('column') && error.message.includes('flag_case')) {
                const updateWithoutCase = {
                    is_flagged: false,
                    flagged_at: null,
                    updated_at: new Date().toISOString()
                };
                
                const { data: data2, error: error2 } = await supabaseClient
                    .from('members')
                    .update(updateWithoutCase)
                    .eq('id', memberId)
                    .select()
                    .single();
                
                if (error2) throw error2;
                
                console.log("Unflagged successfully (without flag_case column)");
                showAlert(`Member unflagged`, 'success');
                
                updateLocalMember(memberId, {
                    is_flagged: false,
                    flag_case: null,
                    flagged_at: null
                });
                
            } else {
                throw error;
            }
        } else {
            console.log("Unflagged successfully!");
            showAlert(`Member "${data.full_name}" has been unflagged`, 'success');
            
            updateLocalMember(memberId, {
                is_flagged: false,
                flag_case: null,
                flagged_at: null
            });
        }
        
        refreshUIAfterFlag();
        return true;
        
    } catch (error) {
        console.error("‚ùå UNFLAG ERROR:", error);
        showAlert(`Failed to unflag member: ${error.message}`, 'error');
        return false;
    }
}

// ============================================
// HELPER FUNCTIONS
// ============================================
function updateLocalMember(memberId, updates) {
    const index = members.findIndex(m => m.id === memberId);
    if (index !== -1) {
        members[index] = { ...members[index], ...updates };
        console.log("Local member updated:", members[index].full_name);
    }
}

function refreshUIAfterFlag() {
    // Update statistics
    updateStats();
    
    // Re-render table based on current filter
    let filtered = [...members];
    if (currentFilter === 'flagged') {
        filtered = members.filter(m => m.is_flagged);
    } else if (currentFilter === 'unflagged') {
        filtered = members.filter(m => !m.is_flagged);
    }
    
    renderTable(filtered);
}

// ============================================
// DATABASE COLUMN CHECK & FIX FUNCTION
// ============================================
async function ensureFlagColumnsExist() {
    console.log("üîß Checking database columns...");
    
    if (!supabaseClient) {
        console.error("Supabase not initialized");
        return false;
    }
    
    try {
        // Get one member to see columns
        const { data, error } = await supabaseClient
            .from('members')
            .select('*')
            .limit(1)
            .single();
        
        if (error) {
            console.error("Cannot check columns:", error);
            return false;
        }
        
        const columns = Object.keys(data);
        console.log("Existing columns:", columns);
        
        // Check for required columns
        const hasIsFlagged = columns.includes('is_flagged');
        const hasFlagCase = columns.includes('flag_case');
        const hasFlaggedAt = columns.includes('flagged_at');
        
        console.log(`‚úì is_flagged column: ${hasIsFlagged ? 'YES' : 'NO'}`);
        console.log(`‚úì flag_case column: ${hasFlagCase ? 'YES' : 'NO'}`);
        console.log(`‚úì flagged_at column: ${hasFlaggedAt ? 'YES' : 'NO'}`);
        
        if (!hasIsFlagged || !hasFlagCase || !hasFlaggedAt) {
            showAlert(
                `‚ö†Ô∏è Database missing columns. Flagging may not work correctly.
                <br>Missing: ${!hasIsFlagged ? 'is_flagged ' : ''}${!hasFlagCase ? 'flag_case ' : ''}${!hasFlaggedAt ? 'flagged_at' : ''}
                <br>Run the SQL below in Supabase SQL Editor.`,
                'warning'
            );
            
            // Show SQL to fix
            console.log(`
                ‚ö†Ô∏è RUN THIS SQL IN SUPABASE SQL EDITOR:
                
                ALTER TABLE members 
                ADD COLUMN IF NOT EXISTS is_flagged BOOLEAN DEFAULT FALSE,
                ADD COLUMN IF NOT EXISTS flag_case TEXT,
                ADD COLUMN IF NOT EXISTS flagged_at TIMESTAMPTZ;
                
                UPDATE members SET is_flagged = false WHERE is_flagged IS NULL;
            `);
            
            return false;
        }
        
        console.log("‚úÖ All required columns exist");
        return true;
        
    } catch (error) {
        console.error("Column check failed:", error);
        return false;
    }
}

// ============================================
// UPDATED EXECUTE PENDING ACTION
// ============================================
async function executePendingAction() {
    if (!pendingAction || !pendingMemberId) {
        console.error("No pending action");
        return;
    }
    
    console.log(`üîÑ Executing: ${pendingAction} for ${pendingMemberId}`);
    
    try {
        switch(pendingAction) {
            case 'flag':
                const flagReason = document.getElementById('flagReason')?.value.trim() || "";
                await flagMember(pendingMemberId, flagReason);
                break;
                
            case 'unflag':
                await unflagMember(pendingMemberId);
                break;
                
            case 'delete':
                // Your existing delete function
                await deleteMember(pendingMemberId);
                break;
                
            case 'clearAll':
                // Your existing clearAll function
                await clearAllMembers();
                break;
        }
        
    } catch (error) {
        console.error("‚ùå Action execution failed:", error);
        showAlert(`Action failed: ${error.message}`, 'error');
    } finally {
        // Always close modal and reset
        closeConfirmationModal();
        pendingAction = null;
        pendingMemberId = null;
    }
}

// ============================================
// UPDATED INITIALIZATION
// ============================================
async function initializeAdminPanel() {
    console.log("=== TRUPPERS ADMIN INITIALIZATION ===");
    
    supabaseClient = initializeSupabase();
    setupEventListeners();
    
    // Check database columns
    setTimeout(async () => {
        await ensureFlagColumnsExist();
        await loadMembers();
    }, 500);
    
    console.log("Admin panel initialization complete");
}

// ============================================
// 4. UNFLAG MEMBER MODULE (COMPLETE)
// ============================================
function showUnflagConfirmation(memberId) {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    pendingAction = 'unflag';
    pendingMemberId = memberId;
    
    document.getElementById('confirmationContent').innerHTML = `
        <p style="margin-bottom: 20px; line-height: 1.6;">
            Are you sure you want to unflag <strong>${escapeHtml(member.full_name)}</strong>?<br>
            <small style="color: var(--gray);">This will remove the red background from the member's row.</small>
        </p>
        <div class="confirmation-actions">
            <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
                <i class="fas fa-undo"></i> Yes, Unflag Member
            </button>
            <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

async function unflagMember(memberId) {
    console.log(`Unflagging member: ${memberId}`);
    
    try {
        if (!supabaseClient) {
            throw new Error("Supabase not initialized");
        }
        
        const { data, error } = await supabaseClient
            .from('members')
            .update({
                is_flagged: false,
                flag_case: null,
                flagged_at: null,
                updated_at: new Date().toISOString()
            })
            .eq('id', memberId)
            .select()
            .single();
        
        if (error) throw error;
        
        // Update local state
        const memberIndex = members.findIndex(m => m.id === memberId);
        if (memberIndex !== -1) {
            members[memberIndex].is_flagged = false;
            members[memberIndex].flag_case = null;
            members[memberIndex].flagged_at = null;
        }
        
        // Refresh table
        if (currentFilter === 'flagged') {
            renderTable(members.filter(m => m.is_flagged));
        } else {
            renderTable([...members]);
        }
        
        updateStats();
        showAlert(`Member "${data.full_name}" has been unflagged`, 'success');
        
    } catch (error) {
        console.error("Error unflagging member:", error);
        showAlert(`Failed to unflag member: ${error.message}`, 'error');
    }
}

// ============================================
// 5. DELETE MEMBER MODULE (COMPLETE)
// ============================================
function showDeleteConfirmation(memberId) {
    const member = members.find(m => m.id === memberId);
    if (!member) return;
    
    pendingAction = 'delete';
    pendingMemberId = memberId;
    
    document.getElementById('confirmationContent').innerHTML = `
        <p style="margin-bottom: 20px; line-height: 1.6; color: var(--accent);">
            <i class="fas fa-exclamation-circle"></i> WARNING: This action cannot be undone!
        </p>
        <p style="margin-bottom: 20px; line-height: 1.6;">
            Are you sure you want to permanently delete <strong>${escapeHtml(member.full_name)}</strong>?<br>
            <small style="color: var(--gray);">This will remove all member data including their photo.</small>
        </p>
        <div class="confirmation-actions">
            <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
                <i class="fas fa-trash"></i> Yes, Delete Permanently
            </button>
            <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

async function deleteMember(memberId) {
    console.log(`Deleting member: ${memberId}`);
    
    try {
        if (!supabaseClient) {
            throw new Error("Supabase not initialized");
        }
        
        const member = members.find(m => m.id === memberId);
        if (!member) {
            throw new Error("Member not found");
        }
        
        // Delete image from storage if exists
        if (member.image_storage_path) {
            try {
                const { error: storageError } = await supabaseClient.storage
                    .from('member-images')
                    .remove([member.image_storage_path]);
                
                if (storageError) {
                    console.warn("Could not delete image from storage:", storageError);
                }
            } catch (storageError) {
                console.warn("Image deletion failed, continuing with member deletion:", storageError);
            }
        }
        
        // Delete member from database
        const { error } = await supabaseClient
            .from('members')
            .delete()
            .eq('id', memberId);
        
        if (error) throw error;
        
        // Update local state
        members = members.filter(m => m.id !== memberId);
        
        // Refresh table
        if (currentFilter === 'flagged') {
            renderTable(members.filter(m => m.is_flagged));
        } else {
            renderTable([...members]);
        }
        
        updateStats();
        showAlert(`Member "${member.full_name}" has been deleted`, 'success');
        
    } catch (error) {
        console.error("Error deleting member:", error);
        showAlert(`Failed to delete member: ${error.message}`, 'error');
    }
}

// ============================================
// 6. CLEAR ALL MODULE (COMPLETE)
// ============================================
function showClearAllConfirmation() {
    if (members.length === 0) {
        showAlert('No members to clear', 'info');
        return;
    }
    
    pendingAction = 'clearAll';
    
    document.getElementById('confirmationContent').innerHTML = `
        <p style="margin-bottom: 20px; line-height: 1.6; color: var(--accent);">
            <i class="fas fa-exclamation-triangle"></i> DANGER: This action cannot be undone!
        </p>
        <p style="margin-bottom: 20px; line-height: 1.6;">
            Are you sure you want to delete ALL ${members.length} members?<br>
            <small style="color: var(--gray);">This will permanently delete all member records including flag cases and explanations.</small>
        </p>
        <div class="confirmation-actions">
            <button class="confirm-btn confirm-yes" onclick="executePendingAction()">
                <i class="fas fa-trash"></i> Yes, Delete All
            </button>
            <button class="confirm-btn confirm-no" onclick="closeConfirmationModal()">
                <i class="fas fa-times"></i> Cancel
            </button>
        </div>
    `;
    
    document.getElementById('confirmationModal').classList.add('active');
}

async function clearAllMembers() {
    console.log("Clearing all members");
    
    try {
        if (!supabaseClient) {
            throw new Error("Supabase not initialized");
        }
        
        // Get all members with image paths
        const { data: allMembers, error: fetchError } = await supabaseClient
            .from('members')
            .select('image_storage_path');
        
        if (fetchError) throw fetchError;
        
        // Delete all images from storage
        const imagePaths = allMembers
            .map(m => m.image_storage_path)
            .filter(path => path);
        
        if (imagePaths.length > 0) {
            try {
                const { error: storageError } = await supabaseClient.storage
                    .from('member-images')
                    .remove(imagePaths);
                
                if (storageError) {
                    console.warn("Could not delete some images from storage:", storageError);
                }
            } catch (storageError) {
                console.warn("Bulk image deletion failed, continuing:", storageError);
            }
        }
        
        // Delete all members from database
        const { error } = await supabaseClient
            .from('members')
            .delete()
            .neq('id', '00000000-0000-0000-0000-000000000000');
        
        if (error) throw error;
        
        // Clear local state
        members = [];
        
        // Refresh UI
        renderTable([]);
        updateStats();
        showAlert('All members have been cleared', 'success');
        
    } catch (error) {
        console.error("Error clearing all members:", error);
        showAlert(`Failed to clear members: ${error.message}`, 'error');
    }
}

// ============================================
// 7. ACTION EXECUTOR
// ============================================
async function executePendingAction() {
    if (!pendingAction || !pendingMemberId) return;
    
    try {
        switch(pendingAction) {
            case 'flag':
                const flagReason = document.getElementById('flagReason')?.value.trim() || "";
                await flagMember(pendingMemberId, flagReason);
                break;
            case 'unflag':
                await unflagMember(pendingMemberId);
                break;
            case 'delete':
                await deleteMember(pendingMemberId);
                break;
            case 'clearAll':
                await clearAllMembers();
                break;
        }
    } catch (error) {
        console.error("Error executing action:", error);
        showAlert('Action failed', 'error');
    } finally {
        closeConfirmationModal();
        pendingAction = null;
        pendingMemberId = null;
    }
}

function closeConfirmationModal() {
    document.getElementById('confirmationModal').classList.remove('active');
    pendingAction = null;
    pendingMemberId = null;
}

// ============================================
// 8. CORE FUNCTIONS (LOAD MEMBERS, RENDER, etc.)
// ============================================
async function loadMembers() {
    console.log("Loading members from Supabase...");
    showAlert("Loading members...", 'info');
    
    if (!supabaseClient) {
        supabaseClient = initializeSupabase();
        if (!supabaseClient) {
            showAlert("Supabase not initialized. Please refresh page.", 'error');
            return;
        }
    }
    
    try {
        const { data, error, count } = await supabaseClient
            .from('members')
            .select('*', { count: 'exact' })
            .order('created_at', { ascending: false });
        
        if (error) throw error;
        
        members = data || [];
        updateStats();
        renderTable(members);
        
        if (members.length === 0) {
            showAlert("No members found in database", 'warning');
        } else {
            showAlert(`Loaded ${members.length} members successfully`, 'success');
        }
        
    } catch (error) {
        console.error("Failed to load members:", error);
        showAlert(`Failed to load members: ${error.message}`, 'error');
        members = [];
        updateStats();
        renderTable([]);
    }
}

function filterMembers(filterType) {
    console.log(`Filtering members: ${filterType}`);
    
    // Update UI
    document.querySelectorAll('.filter-btn').forEach(btn => {
        btn.classList.remove('active');
    });
    event.target.classList.add('active');
    
    currentFilter = filterType;
    
    let filteredMembers = [...members];
    
    switch(filterType) {
        case 'flagged':
            filteredMembers = members.filter(m => m.is_flagged === true);
            break;
        case 'unflagged':
            filteredMembers = members.filter(m => !m.is_flagged);
            break;
        case 'all':
        default:
            break;
    }
    
    console.log(`Showing ${filteredMembers.length} members after filter`);
    renderTable(filteredMembers);
}

function updateStats() {
    const total = members.length;
    const flagged = members.filter(m => m.is_flagged).length;
    const verified = members.filter(m => m.is_verified).length;
    
    document.getElementById('totalMembers').textContent = total;
    document.getElementById('flaggedMembers').textContent = flagged;
    document.getElementById('verifiedMembers').textContent = verified;
    document.getElementById('tableCount').textContent = `${total} members`;
}

function renderTable(memberList) {
    const tbody = document.getElementById('tableBody');
    tbody.innerHTML = '';
    
    if (!memberList || memberList.length === 0) {
        tbody.innerHTML = `
            <tr>
                <td colspan="5" style="text-align: center; padding: 40px; color: var(--gray);">
                    <i class="fas fa-user-slash" style="font-size: 2.5rem; margin-bottom: 15px; display: block;"></i>
                    ${members.length === 0 ? 'No members in database' : 'No members match filter'}
                </td>
            </tr>
        `;
        return;
    }
    
    memberList.forEach((member, index) => {
        const row = document.createElement('tr');
        if (member.is_flagged) row.classList.add('flagged');
        
        row.innerHTML = `
            <td>
                <div class="member-photo-container">
                    <img src="${member.image_url || 'https://via.placeholder.com/70/0a0a14/00ffcc?text=No+Photo'}" 
                         class="member-photo" 
                         alt="${member.full_name}"
                         onerror="this.src='https://via.placeholder.com/70/0a0a14/00ffcc?text=Error'">
                </div>
            </td>
            <td>
                <div class="name-cell">${escapeHtml(member.full_name) || 'N/A'}</div>
            </td>
            <td>
                <div class="phone-cell">${escapeHtml(member.phone_number) || 'N/A'}</div>
            </td>
            <td>
                <span class="verification-code">${escapeHtml(member.verification_code) || 'N/A'}</span>
            </td>
            <td>
                <div class="action-buttons">
                    <button class="btn btn-view" onclick="viewMember('${member.id}')">
                        <i class="fas fa-eye"></i> View
                    </button>
                    ${member.is_flagged ? 
                        `<button class="btn btn-unflag" onclick="showUnflagConfirmation('${member.id}')">
                            <i class="fas fa-undo"></i> Unflag
                        </button>` : 
                        `<button class="btn btn-flag" onclick="showFlagConfirmation('${member.id}')">
                            <i class="fas fa-flag"></i> Flag
                        </button>`
                    }
                    <button class="btn btn-delete" onclick="showDeleteConfirmation('${member.id}')">
                        <i class="fas fa-trash"></i> Delete
                    </button>
                </div>
            </td>
        `;
        
        tbody.appendChild(row);
    });
}

// ============================================
// 9. UTILITY FUNCTIONS
// ============================================
function showAlert(message, type = 'info') {
    let alertBox = document.getElementById('globalAlert');
    if (!alertBox) {
        alertBox = document.createElement('div');
        alertBox.id = 'globalAlert';
        alertBox.style.cssText = `
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 15px 20px;
            border-radius: 10px;
            color: white;
            z-index: 9999;
            animation: slideIn 0.3s ease;
            box-shadow: var(--shadow);
            max-width: 400px;
        `;
        document.body.appendChild(alertBox);
    }
    
    const colors = {
        success: 'background: rgba(0, 255, 204, 0.2); border: 1px solid var(--primary);',
        error: 'background: rgba(255, 77, 77, 0.2); border: 1px solid var(--accent);',
        warning: 'background: rgba(255, 170, 0, 0.2); border: 1px solid #ffaa00;',
        info: 'background: var(--glass); border: 1px solid var(--glass-border);'
    };
    
    alertBox.style.cssText += colors[type] || colors.info;
    alertBox.innerHTML = `<i class="fas fa-info-circle"></i> ${message}`;
    
    setTimeout(() => {
        if (alertBox.parentNode) {
            alertBox.style.animation = 'slideIn 0.3s ease reverse';
            setTimeout(() => alertBox.remove(), 300);
        }
    }, 4000);
}

function escapeHtml(text) {
    if (!text) return '';
    const div = document.createElement('div');
    div.textContent = text;
    return div.innerHTML;
}

// ============================================
// 10. SETUP EVENT LISTENERS
// ============================================
function setupEventListeners() {
    console.log("Setting up event listeners...");
    
    // Filter buttons
    document.querySelectorAll('.filter-btn').forEach((btn, index) => {
        btn.addEventListener('click', function(e) {
            const filterMap = ['all', 'flagged', 'unflagged'];
            if (index === 3) {
                showClearAllConfirmation();
            } else {
                filterMembers(filterMap[index]);
            }
        });
    });
    
    // Refresh button
    const refreshBtn = document.querySelector('.fa-sync-alt');
    if (refreshBtn) {
        refreshBtn.addEventListener('click', loadMembers);
    }
    
    // Search input
    const searchInput = document.getElementById('searchInput');
    if (searchInput) {
        let searchTimeout;
        searchInput.addEventListener('input', function() {
            clearTimeout(searchTimeout);
            searchTimeout = setTimeout(() => {
                const query = this.value.toLowerCase();
                if (!query.trim()) {
                    filterMembers(currentFilter);
                    return;
                }
                
                const filtered = members.filter(m =>
                    (m.full_name && m.full_name.toLowerCase().includes(query)) ||
                    (m.phone_number && m.phone_number.toLowerCase().includes(query)) ||
                    (m.verification_code && m.verification_code.toLowerCase().includes(query))
                );
                renderTable(filtered);
            }, 300);
        });
    }
    
    // Modal close buttons
    const closeButtons = document.querySelectorAll('.modal-close');
    closeButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            closeModal();
            closeConfirmationModal();
        });
    });
    
    // Close modals on overlay click
    document.getElementById('memberModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeModal();
        }
    });
    
    document.getElementById('confirmationModal').addEventListener('click', (e) => {
        if (e.target.classList.contains('modal-overlay')) {
            closeConfirmationModal();
        }
    });
    
    console.log("Event listeners setup complete");
}

// ============================================
// 11. MAIN INITIALIZATION
// ============================================
async function initializeAdminPanel() {
    console.log("=== TRUPPERS ADMIN INITIALIZATION ===");
    
    supabaseClient = initializeSupabase();
    setupEventListeners();
    
    setTimeout(() => {
        loadMembers();
    }, 500);
    
    console.log("Admin panel initialization complete");
}

// ============================================
// 12. GLOBAL EXPORTS
// ============================================
window.loadMembers = loadMembers;
window.filterMembers = filterMembers;
window.viewMember = viewMember;
window.showFlagConfirmation = showFlagConfirmation;
window.showUnflagConfirmation = showUnflagConfirmation;
window.showDeleteConfirmation = showDeleteConfirmation;
window.showClearAllConfirmation = showClearAllConfirmation;
window.executePendingAction = executePendingAction;
window.closeModal = closeModal;
window.closeConfirmationModal = closeConfirmationModal;

// ============================================
// 13. START APPLICATION
// ============================================
if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initializeAdminPanel);
} else {
    initializeAdminPanel();
}
</script>
</body>
</html>
